# Please make sure that the `needs` field for the `conclusion` job
# are updated when adding new jobs!

name: Continuous integration

on:
  pull_request:
  merge_group:

permissions: {}

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CI: 1
  RUST_BACKTRACE: short
  RUSTUP_MAX_RETRIES: 10
  RUSTFLAGS: -D warnings
  NIGHTLY_TOOLCHAIN: nightly

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  rust:
    name: Rust
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.0
        with:
          components: clippy

      # https://github.com/actions-rust-lang/setup-rust-toolchain/blob/main/rust.json
      - name: Install Rust Problem Matcher
        if: matrix.os == 'macos-latest'
        run: echo "::add-matcher::.github/rust.json"

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Test
        run: cargo nextest run --no-fail-fast --hide-progress-bar --status-level fail

      - name: Clippy
        # Because macos runners are the fastest
        if: matrix.os == 'macos-latest'
        run: cargo clippy --all-targets --all-features -- -D warnings

  rustfmt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.0
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  miri:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_TOOLCHAIN }}
          components: miri

  markdown:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          config: .markdownlint.jsonc
          globs: "**/*.md"

  toml:
    name: Check TOML formatting
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Check formatting with with Taplo
        uses: docker://docker.io/tamasfe/taplo:latest
        with:
          args: fmt --check --diff

      - name: Taplo info
        if: failure()
        run: |
          echo 'To fix toml fmt, please run `taplo fmt`.'
          echo 'To check for a diff, run `taplo fmt --check --diff`.'
          echo 'You can find taplo here: https://taplo.tamasfe.dev/.'
          echo 'Also use the `Even Better Toml` extension.'
          echo 'You can find the extension here: https://marketplace.visualstudio.com/items?itemName=tamasfe.even-better-toml'

  typos:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Check for typos
        uses: crate-ci/typos@v1.42.0

      - name: Typos info
        if: failure()
        run: |
          echo 'To fix typos, please run `typos -w`'
          echo 'To check for a diff, run `typos`'
          echo 'You can find typos here: https://crates.io/crates/typos'
          echo 'if you use VS Code, you can also install `Typos Spell Checker'
          echo 'You can find the extension here: https://marketplace.visualstudio.com/items?itemName=tekumara.typos-vscode'

  rustdoc:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install beta Rust toolchain
        uses: dtolnay/rust-toolchain@beta

      - name: Build documentation
        run: cargo doc --all-features --no-deps --document-private-items --keep-going
        env:
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: -C debuginfo=0 -D warnings

      - name: Documentation tests
        run: cargo test --doc
        env:
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: -C debuginfo=0 -D warnings

      - name: Installs cargo-deadlinks
        uses: taiki-e/install-action@cargo-deadlinks

      - name: Checks dead links
        run: cargo deadlinks --dir target/doc
        continue-on-error: true

  check-unused-dependencies:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # cargo-udeps requires this toolchain at runtime
      - name: Install nightly Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_TOOLCHAIN }}

      - name: Install cargo-udeps
        uses: taiki-e/install-action@cargo-udeps
      - name: Run cargo-udeps
        run: cargo udeps

  conclusion:
    needs:
      [
        rust,
        markdown,
        rustfmt,
        miri,
        toml,
        typos,
        rustdoc,
        check-unused-dependencies,
      ]
    # We need to ensure this job does *not* get skipped if its dependencies fail,
    # because a skipped job is considered a success by GitHub. So we have to
    # overwrite `if:`. We use `!cancelled()` to ensure the job does still not get run
    # when the workflow is canceled manually.
    #
    # ALL THE PREVIOUS JOBS NEED TO BE ADDED TO THE `needs` SECTION OF THIS JOB!
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      # Manually check the status of all dependencies. `if: failure()` does not work.
      - name: Conclusion
        run: |
          # Print the dependent jobs to see them in the CI log
          jq -C <<< '${{ toJson(needs) }}'
          # Check if all jobs that we depend on (in the needs array) were successful (or have been skipped).
          jq --exit-status 'all(.result == "success" or .result == "skipped")' <<< '${{ toJson(needs) }}'

  cancel-if-matrix-failed:
    needs: rust
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Cancel parallel jobs
        run: |
          if jq --exit-status 'all(.result == "success" or .result == "skipped")' <<< '${{ toJson(needs) }}'; then
            exit 0
          fi
          # https://docs.github.com/en/rest/actions/workflow-runs?apiVersion=2022-11-28#cancel-a-workflow-run
          curl -L \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel
